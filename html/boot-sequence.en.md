# Boot Sequence of genpack Images

## Overview

SquashFS images generated by genpack can be booted in two ways: on physical hardware installed to disk, and in a QEMU/KVM paravirtual environment via the `vm` command. In both cases, a common initramfs (dracut-genpack) constructs an overlayfs root, and genpack-init performs initial configuration based on system.ini before handing control to systemd.

This document describes the boot sequence for both methods in detail.

## system.img Method (Disk Install)

### Disk Layout

When installed to disk with `genpack-install`, the following partition layout is created:

| Partition | Filesystem | Contents |
|---|---|---|
| 1: Boot partition | FAT32 | EFI bootloader, kernel, initramfs, system.img (if < 4GiB), system.ini |
| 2: Data partition | Btrfs | overlayfs upper layer, system (if >= 4GiB) |

The boot partition size is automatically calculated from the image size. The `--superfloppy` option skips partition table creation and uses the entire disk as FAT32 (no data partition).

MBR or GPT is automatically selected based on disk size (MBR for <= 2TiB with 512-byte sectors, GPT otherwise).

### Boot Sequence

```
UEFI/BIOS
  → GRUB (efi/boot/bootx64.efi etc.)
    → Linux kernel (root=systemimg:<UUID> or root=systemimg:auto)
      → initramfs (dracut-genpack)
        → overlayfs root construction
          → genpack-init (PID 1)
            → Python plugins for initial configuration
              → exec /sbin/init (systemd)
```

### initramfs Processing (dracut-genpack)

dracut-genpack consists of two hooks.

**cmdline hook (check-systemimg-root.sh):**

Checks the `root=` parameter in the kernel command line. If it matches the `root=systemimg:...` format, the genpack boot sequence begins.

**mount hook (mount-genpack.sh):**

1. **Boot partition detection and mount**
   - `root=systemimg:<UUID>`: Mount the partition with the specified UUID
   - `root=systemimg:auto`: Scan all FAT partitions to find one containing `system.img`
   - For FAT, run `fsck.fat -aw` for automatic repair before mounting
   - Mount point: `/run/initramfs/boot`

2. **Data partition detection and mount**
   - Search by label `data-<UUID>` based on the boot partition's UUID
   - Fallback: `d-<UUID>`, `wbdata-<UUID>`, or the next partition number after the boot partition [^2]
   - If not found, attempt virtiofs (`fs` tag) [^3]
   - If still unmountable, fall back to tmpfs (transient mode)
   - `genpack.transient` kernel parameter can explicitly specify transient mode
   - Mount point: `/run/initramfs/rw`

3. **SquashFS image mount**
   - Search for `/run/initramfs/boot/system.img` on the boot partition
   - If not found, use `/run/initramfs/rw/system` on the data partition
   - Mount read-only at `/run/initramfs/ro`

4. **overlayfs construction**
   - lowerdir: `/run/initramfs/ro` (SquashFS, read-only)
   - upperdir: `/run/initramfs/rw/root` (Btrfs or tmpfs) [^5]
   - workdir: `/run/initramfs/rw/work`
   - Mount overlay at `$NEWROOT`
   - Synchronize lower layer's `/usr` timestamp to the upper layer [^4]

5. **Shutdown program placement**
   - Copy `/run/initramfs/ro/usr/libexec/genpack-shutdown` to `/run/initramfs/shutdown`
   - Used for safely unmounting overlayfs and SquashFS during shutdown

### genpack-init

Once dracut's initramfs processing completes, the root switches to `$NEWROOT` and `/usr/bin/genpack-init` starts as PID 1 (`init=/usr/bin/genpack-init` is added to the cmdline by the dracut module).

genpack-init is implemented in C++ + pybind11 and performs the following:

1. Load `/run/initramfs/boot/system.ini` (via boot partition) or `/run/initramfs/rw/system.ini` (via data partition)
2. Load all Python modules in `/usr/lib/genpack-init/*.py` in filename order
3. Execute each module's `configure(ini)` function (timezone, locale, banner display, machine ID generation, etc.)
4. Hand control to systemd via `exec /sbin/init`

## Paravirtual Method (vm command)

### vm Command Overview

The `vm` command is a tool for directly booting genpack images with QEMU/KVM. No disk installation is required — you can specify and boot a SquashFS file directly.

### Boot Sequence

```
vm run system.squashfs
  → Extract kernel and initramfs from SquashFS (memfd)
    → qemu-system-<arch> -kernel <kernel> -initrd <initramfs>
       -append "root=/dev/vda ro ..."
       -drive file=system.squashfs,...,serial=system  (virtio-blk)
       -drive file=data,...,serial=data  (virtio-blk, if present)
      → initramfs (dracut-genpack)
        → overlayfs root construction
          → genpack-init (PID 1)
            → Python plugins for initial configuration
              → exec /sbin/init (systemd)
```

### Kernel and initramfs Extraction

The vm command uses the squashfuse library to read the kernel and initramfs directly from the `/boot/` directory within the SquashFS image. There is no need to extract to disk — the files are written to file descriptors created with `memfd_create` and passed to QEMU.

Search order:
1. `boot/kernel` or `boot/vmlinuz` (fixed names)
2. `boot/kernel-*` or `boot/vmlinuz-*` (most recent by timestamp)

initramfs is similarly searched in the order: `boot/initramfs`, `boot/initramfs.img`, `boot/initrd.img`.

The architecture (x86_64, aarch64, riscv64, etc.) is automatically detected from the ELF header or PE header of the kernel binary, and the corresponding `qemu-system-<arch>` is launched.

### QEMU Launch Configuration

The vm command uses QEMU's direct kernel boot (`-kernel`, `-initrd`, `-append`). No bootloader is involved.

**Kernel command line:**

```
root=/dev/vda ro net.ifnames=0 systemd.firstboot=0 systemd.hostname=<vmname> console=...
```

- `root=/dev/vda`: The SquashFS image is provided as a virtio-blk device
- For virtiofs mode: `root=fs rootfstype=virtiofs rw`

**Disk provisioning:**

| virtio device | Serial | Contents |
|---|---|---|
| vda | system | SquashFS image (read-only) |
| vdb | data | Data disk (if present) |
| vdc | swap | Swap file (if present) |

The SquashFS image is attached as a `virtio-blk-pci` device in read-only mode. The initramfs `mount-genpack.sh` references the kernel command line's `root=/dev/vda` (not `root=block:*`) and mounts `/dev/vda` directly as SquashFS at `/run/initramfs/ro`.

**virtiofs mode:**

The vm command also supports virtiofs. It launches virtiofsd to share a host directory with the guest, which can be used as the overlayfs upper layer. When using virtiofs, the initramfs mounts virtiofs as root based on `root=fs rootfstype=virtiofs rw`.

### vm Service Mode

The `vm` command has a service mode that reads `vm.ini` files. The directory structure for each VM is as follows:

```
/var/vm/<vmname>/
├── vm.ini        # VM configuration (memory, CPU, network, etc.)
├── system        # SquashFS image (can be a symlink)
├── data          # Data disk (optional)
├── swapfile      # Swap (optional)
├── fs/           # virtiofs shared directory
├── docker        # Docker disk (optional, serial=docker)
└── mysql         # MySQL disk (optional, serial=mysql)
```

`type=genpack` (the default) in `vm.ini` enables direct kernel boot.

### Comparison with the system.img Method

| Aspect | system.img method | Paravirtual method |
|---|---|---|
| Bootloader | GRUB (EFI/BIOS) | None (direct kernel boot) |
| Kernel location | File on boot partition | Extracted from SquashFS to memfd |
| root= parameter | `systemimg:<UUID>` or `systemimg:auto` | `/dev/vda` |
| SquashFS delivery | File on boot/data partition | virtio-blk device |
| Data persistence | Btrfs partition | Data disk file or virtiofs |
| Transient mode | `genpack.transient` kernel parameter | Automatic when no data disk specified |
| system.ini | On FAT32 partition | Via virtiofs or fw_cfg |
| initramfs behavior | Common (dracut-genpack) | Common (dracut-genpack) |
| genpack-init behavior | Common | Common |

## Shutdown

Shutdown of a genpack image follows the normal systemd shutdown process, after which control returns to dracut's initramfs and `/run/initramfs/shutdown` (genpack-shutdown) executes. genpack-shutdown performs the following:

1. Unmount all mount points under `/oldroot` in reverse order
2. Safely move and unmount `/run/initramfs/rw` (data partition) and `/run/initramfs/boot` (boot partition)
3. Delete `boottime.txt` on the boot partition [^1]
4. Execute `reboot(2)` or `poweroff`

---

[^1]: boottime.txt is created at boot time. Since it is deleted during a clean shutdown, its presence at the next boot serves as evidence of an unclean shutdown (crash or power loss).

[^2]: `d-<UUID>` is the current canonical label format (shortened due to Btrfs label length limitations). `data-<UUID>` and `wbdata-<UUID>` are retained for backward compatibility with the Walbrix era (genpack's predecessor).

[^3]: The systemimg method is not exclusive to physical hardware — it can also be used when running directly on QEMU without the vm frontend. This fallback allows baremetal profile images to boot in paravirtual environments as well. This is also why the baremetal profile exists as a specialization of systemimg.

[^4]: systemd uses the `/usr` timestamp to determine whether `ld.so.cache` needs to be regenerated. In overlayfs, the upper layer's presence masks the lower layer's timestamps, so the lower layer's `/usr` timestamp must be explicitly propagated to the upper layer.

[^5]: In older versions, the upperdir used the redundant path `rw/rw/root`. This was simplified to `rw/root`, but the initramfs continues to recognize the old path `rw/rw/root` for backward compatibility with existing deployments.

## Source References

This document was created based on snapshots of the following repositories:

- [wbrxcorp/genpack-install @ HEAD](https://github.com/wbrxcorp/genpack-install)
- [wbrxcorp/genpack-overlay @ HEAD](https://github.com/wbrxcorp/genpack-overlay) (sys-kernel/dracut-genpack, genpack/base)
- [wbrxcorp/genpack-init @ HEAD](https://github.com/wbrxcorp/genpack-init)
- [shimarin/vm @ HEAD](https://github.com/shimarin/vm)
